/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file    gpio.c
  * @brief   This file provides code for the configuration
  *          of all used GPIO pins.
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2025 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
/* USER CODE END Header */

/* Includes ------------------------------------------------------------------*/
#include "gpio.h"
#include "project.h"

/* USER CODE BEGIN 0 */
extern SystemMonitorValues_t values;

#define CHARGER_DETECT_PIN      GPIO_PIN_5
#define CHARGER_DETECT_PORT     GPIOB
#define AMS_STATUS_PIN          GPIO_PIN_4
#define AMS_STATUS_PORT         GPIOB
/* USER CODE END 0 */

/*----------------------------------------------------------------------------*/
/* Configure GPIO                                                             */
/*----------------------------------------------------------------------------*/
/* USER CODE BEGIN 1 */

/* USER CODE END 1 */

/** Configure pins as
        * Analog
        * Input
        * Output
        * EVENT_OUT
        * EXTI
*/
void MX_GPIO_Init(void){

  GPIO_InitTypeDef GPIO_InitStruct = {0};

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOF_CLK_ENABLE();
  __HAL_RCC_GPIOG_CLK_ENABLE();
  __HAL_RCC_GPIOA_CLK_ENABLE();
  __HAL_RCC_GPIOB_CLK_ENABLE();
  __HAL_RCC_GPIOC_CLK_ENABLE();

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(NRST_GPIO_Port, NRST_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(RLED_GPIO_Port, RLED_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(GPIOB, AMS_STATUS_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin : PtPin */
  GPIO_InitStruct.Pin = NRST_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(NRST_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : PtPin */
  GPIO_InitStruct.Pin = RLED_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(RLED_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pins : PBPin PBPin */
  GPIO_InitStruct.Pin = AMS_STATUS_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(GPIOB, &GPIO_InitStruct);

  /*Configure GPIO pin : CHARGER_ENABLE - Input to detect charger connection */
  GPIO_InitStruct.Pin = CHARGER_ENABLE_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_INPUT;
  GPIO_InitStruct.Pull = GPIO_PULLDOWN;  // Assumes charger pulls high when connected
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(GPIOB, &GPIO_InitStruct);

}

/* USER CODE BEGIN 2 */
/**
 * @brief Set LED state
 * @param led LED identifier (0 = Red LED)
 * @param state LED state (0 = off, 1 = on)
 */
void LED_Set(uint8_t led, uint8_t state){
    (void)led;
    if (state){
            HAL_GPIO_WritePin(RLED_GPIO_Port, RLED_Pin, GPIO_PIN_SET);
    }
    else{
            HAL_GPIO_WritePin(RLED_GPIO_Port, RLED_Pin, GPIO_PIN_RESET);
    }

}
/**
 * @brief Check charger connection and set system mode accordingly
 */
void CheckChargerConnection(void){
    GPIO_PinState chargerConnected = HAL_GPIO_ReadPin(CHARGER_DETECT_PORT, CHARGER_DETECT_PIN);
    
    if (chargerConnected == GPIO_PIN_SET){
        // Charger is connected - switch to CHARGE mode
        if (values.mode != CHARGE){
            setSystemMode(CHARGE);
        }
    }
    else{
        // Charger is disconnected - switch to DISCHARGE mode
        if (values.mode != DISCHARGE){
            setSystemMode(DISCHARGE);
        }
    }
}

/**
 * @brief Update AMS status output pin based on SDC status
 */
void UpdateAMSStatus(void){
    if (values.SDCstatus == true){
        HAL_GPIO_WritePin(AMS_STATUS_PORT, AMS_STATUS_PIN, GPIO_PIN_SET);
    }
    else{
        HAL_GPIO_WritePin(AMS_STATUS_PORT, AMS_STATUS_PIN, GPIO_PIN_RESET);
    }
}

/* USER CODE END 2 */
